<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CSV Username Builder + Moodle Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0;
            --green:#16a34a; --green-bg:#dcfce7; --green-border:#86efac; --focus:#2563eb; --danger:#dc2626; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px;font-weight:700}
    .sub{color:var(--muted);margin-bottom:18px;line-height:1.5}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .uploader{border:2px dashed var(--border);border-radius:12px;padding:16px;text-align:center;flex:1;min-width:280px;background:#f9fafb}
    .uploader input{display:none}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .hint{font-size:13px;color:var(--muted);margin-top:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:9999px;background:#eef2ff;border:1px solid var(--border);color:#334155;font-size:12px}
    .ok{color:var(--green)} .error{color:var(--danger)} .spacer{flex:1}

    .table-wrap{margin-top:16px;border:1px solid var(--border);border-radius:12px;overflow:auto;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#f5f7fb;text-align:left;padding:12px;font-size:13px;color:#1f2937;border-bottom:1px solid var(--border)}
    tbody td{padding:12px;border-bottom:1px solid var(--border);font-size:14px;color:#111827;vertical-align:middle}
    tbody tr:hover{background:#fafcff}

    .namecell{display:flex;align-items:center;gap:10px}
    .avatar{width:28px;height:28px;border-radius:9999px;display:inline-grid;place-items:center;font-weight:700;font-size:11px;color:#fff;background:linear-gradient(135deg,#0ea5e9,#8b5cf6)}
    .subtle{color:var(--muted);font-size:12px}

    /* progress bar + live log */
    .progress{margin-top:12px;display:flex;align-items:center;gap:10px}
    .bar{flex:1;height:10px;background:#f1f5f9;border-radius:9999px;overflow:hidden;border:1px solid #e5e7eb}
    .bar > div{height:100%;width:0%;background:#16a34a;transition:width .15s ease}
    .pct{min-width:42px;text-align:right;font-variant-numeric:tabular-nums}
    .log{margin-top:10px;background:#0b1220;color:#e5e7eb;border-radius:8px;border:1px solid #1f2937;padding:10px;max-height:180px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}

    .footer{margin-top:14px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CSV ‚Üí Moodle</h1>
    <div class="sub">
      Upload CSV ‚Üí preview ‚Üí create/unsuspend/enrol on Moodle. Headers unchanged. Optional column: <b>Course IDs</b>.
    </div>

    <div class="card">
      <div class="row">
        <label class="uploader" id="dropzone" tabindex="0" aria-label="Upload CSV">
          <input type="file" id="fileInput" accept=".csv,text/csv" />
          <div><b>Drop CSV here</b> or <button class="btn" id="browseBtn" type="button">Browse‚Ä¶</button></div>
          <div class="hint">Required: <code>First Name</code>, <code>Last Name</code>, <code>Email Address</code></div>
        </label>

        <button id="downloadBtn" class="btn" disabled>‚¨áÔ∏è Download CSV</button>
        <button id="moodleBtn" class="btn" disabled>üöÄ Send to Moodle</button>
        <button id="sampleBtn" class="btn" type="button">üìÑ Sample CSV</button>
        <span id="status" class="badge" role="status" aria-live="polite">Waiting for file‚Ä¶</span>
        <div class="spacer"></div>
      </div>

      <!-- progress + live log -->
      <div class="progress" id="progressWrap" style="display:none;">
        <div class="bar"><div id="barInner"></div></div>
        <div class="pct" id="pct">0%</div>
      </div>
      <div class="log" id="log" style="display:none;"></div>

      <div class="table-wrap" id="tableWrap" style="display:none;">
        <table id="resultTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer" id="footerNote" style="display:none;">
        Processed <span id="rowCount">0</span> rows ‚Ä¢ CSV export preserves columns exactly as shown.
      </div>
    </div>
  </div>

  <script>
    // SAME columns as backend
    const COLUMNS = [
      "First Name","Last Name","Email Address","Username","Password",
      "Course IDs",
      "Status","Enrol Status","Suspend Status",
      "Existing First Name","Existing Last Name","Existing Username","Existing Email","Existing ID"
    ];

    const $ = s => document.querySelector(s);
    const statusEl = $('#status'), errEl = $('#error'),
          tableWrap=$('#tableWrap'), tbody = document.querySelector('#resultTable tbody'),
          rowCountEl = $('#rowCount'),
          downloadBtn=$('#downloadBtn'), moodleBtn=$('#moodleBtn'), sampleBtn=$('#sampleBtn'),
          progressWrap = $('#progressWrap'), barInner = $('#barInner'), pctEl = $('#pct'),
          logEl = $('#log');

    let lastRows=[], lastCSVBlob=null, evtSource=null;

    // Build header once
    (function buildHeader(){
      const tr = document.getElementById('theadRow');
      tr.innerHTML='';
      for(const c of COLUMNS){ const th=document.createElement('th'); th.textContent=c; tr.appendChild(th); }
    })();

    function ensureAllColumns(row){ const x={...row}; for(const c of COLUMNS) if(!(c in x)) x[c]=''; return x; }

    function renderTable(rows){
      tbody.innerHTML='';
      for(const r0 of rows){
        const r = ensureAllColumns(r0);
        const tr=document.createElement('tr');
        for(const col of COLUMNS){
          const td=document.createElement('td');
          if(col==="First Name"){
            td.innerHTML = `
              <div class="namecell">
                <div class="avatar">${((r["First Name"]||"").charAt(0)+ (r["Last Name"]||"").charAt(0)).toUpperCase() || "‚Ä¢"}</div>
                <div>
                  <div>${r["First Name"]||""}</div>
                  <div class="subtle">${r["Username"]||""}</div>
                </div>
              </div>`;
          }else{
            td.textContent = r[col] ?? '';
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      tableWrap.style.display = rows.length ? 'block' : 'none';
      rowCountEl.textContent = rows.length;
      $('#footerNote').style.display = rows.length ? 'block' : 'none';
    }

    function updateRow(index, row){
      lastRows[index] = ensureAllColumns(row);
      // Re-render just that row
      const tr = tbody.children[index];
      if(!tr){ renderTable(lastRows); return; }
      tr.innerHTML='';
      for(const col of COLUMNS){
        const td=document.createElement('td');
        const r = lastRows[index];
        if(col==="First Name"){
          td.innerHTML = `
            <div class="namecell">
              <div class="avatar">${((r["First Name"]||"").charAt(0)+ (r["Last Name"]||"").charAt(0)).toUpperCase() || "‚Ä¢"}</div>
              <div>
                <div>${r["First Name"]||""}</div>
                <div class="subtle">${r["Username"]||""}</div>
              </div>
            </div>`;
        }else{
          td.textContent = r[col] ?? '';
        }
        tr.appendChild(td);
      }
    }

    function setStatus(msg, ok=false){ statusEl.textContent=msg; statusEl.classList.toggle('ok', ok); }
    function showError(msg){ if(!errEl){console.error(msg);return;} errEl.style.display='block'; errEl.textContent=msg; }
    function clearError(){ if(!errEl) return; errEl.style.display='none'; errEl.textContent=''; }

    async function previewOnServer(file){
      const form=new FormData(); form.append('file', file);
      const res=await fetch('/api/preview',{method:'POST',body:form});
      if(!res.ok){ let msg=await res.text(); try{msg=JSON.parse(msg).error}catch{}; throw new Error(msg); }
      return (await res.json()).rows;
    }

    // ---------- Streaming send ----------
    async function sendToMoodleStreaming(users){
      // start job
      const res = await fetch('/api/moodle/start',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({rows:users})
      });
      const data = await res.json();
      if(!res.ok){ showError(data.error||'Server error'); return; }

      const jobId = data.job_id;
      // UI prep
      setStatus('Processing‚Ä¶');
      progressWrap.style.display='flex';
      logEl.style.display='block';
      barInner.style.width='0%'; pctEl.textContent='0%';
      moodleBtn.disabled = true;

      // open SSE
      if(evtSource) { evtSource.close(); }
      evtSource = new EventSource('/api/moodle/stream/'+jobId);

      evtSource.addEventListener('hello', e=>{
        log(`connected (job ${JSON.parse(e.data).job_id})`);
      });

      evtSource.addEventListener('stage', e=>{
        const d = JSON.parse(e.data);
        log(d.message);
      });

      evtSource.addEventListener('row_update', e=>{
        const d = JSON.parse(e.data);
        updateRow(d.index, d.row);
      });

      evtSource.addEventListener('progress', e=>{
        const d = JSON.parse(e.data);
        const p = Math.max(0, Math.min(100, d.percent|0));
        barInner.style.width = p + '%';
        pctEl.textContent = p + '%';
      });

      evtSource.addEventListener('done', async e=>{
        barInner.style.width = '100%'; pctEl.textContent = '100%';
        setStatus('Moodle sync finished ‚úî', true);
        evtSource.close();
        // fetch final rows (optional ‚Äì table already updated progressively)
        try{
          const finalRes = await fetch('/api/moodle/result/'+jobId);
          const finalData = await finalRes.json();
          if(finalRes.ok && finalData.rows){ lastRows = finalData.rows.map(ensureAllColumns); renderTable(lastRows); }
        }catch{}
        // Generate CSV (with BOM)
        const csv = Papa.unparse(lastRows, { columns: COLUMNS });
        const BOM = '\uFEFF';
        lastCSVBlob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8' });
        downloadBtn.disabled = lastRows.length===0;
        moodleBtn.disabled = false;
        log('done.');
      });

      evtSource.onerror = () => {
        log('‚ö†Ô∏è stream error (network or server).');
      };
    }

    function log(msg){
      const t = new Date().toLocaleTimeString();
      logEl.textContent += `[${t}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function handleFile(file){
      if(!file) return;
      clearError(); setStatus(`Uploading "${file.name}"‚Ä¶`);
      try{
        lastRows = (await previewOnServer(file)).map(ensureAllColumns);
        renderTable(lastRows);
        const csv = Papa.unparse(lastRows, { columns: COLUMNS });
        const BOM = '\uFEFF';
        lastCSVBlob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8' });
        downloadBtn.disabled = lastRows.length===0;
        moodleBtn.disabled   = lastRows.length===0;
        setStatus(`Processed ${lastRows.length} row(s) ‚úî`, true);
      }catch(e){
        showError(e.message || String(e));
        setStatus('Failed');
      }
    }

    // controls
    const input=$('#fileInput'), drop=$('#dropzone'), browse=$('#browseBtn');
    browse.addEventListener('click', ()=>input.click());
    input.addEventListener('change', ()=>handleFile(input.files[0]));
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.borderColor='#cbd5e1';}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.borderColor='var(--border)';}));
    drop.addEventListener('drop', e=>{
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if(file){ input.files = e.dataTransfer.files; handleFile(file); }
    });
    drop.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); input.click(); }});

    $('#moodleBtn').addEventListener('click', ()=>sendToMoodleStreaming(lastRows));
    $('#downloadBtn').addEventListener('click', ()=>{
      if(!lastCSVBlob) return;
      const a=document.createElement('a');
      a.href=URL.createObjectURL(lastCSVBlob);
      a.download='usernames_output.csv';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
    });
    $('#sampleBtn').addEventListener('click', ()=>{
      const sample=[
        {"First Name":"Sara","Last Name":"Khan","Email Address":"sara.khan@example.com","Course IDs":"2628"},
        {"First Name":"Ali","Last Name":"Hassan","Email Address":"ali.hassan@example.com","Course IDs":"2628,2731"}
      ];
      const csv=Papa.unparse(sample,{columns:["First Name","Last Name","Email Address","Course IDs"]});
      const BOM='\uFEFF';
      const blob=new Blob([BOM+csv],{type:'text/csv;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='sample_usernames.csv';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
    });
  </script>
</body>
</html>
